<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Products - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-success p-2">
        <div class="container-fluid">
            <a class="navbar-brand" href="index.html">
                <img src="../images/logo.png" alt="Logo" class="logo">
            </a>
            <span class="navbar-text text-light ms-auto me-3">Admin • Manage Products</span>
        </div>
    </nav>

    <div class="container-fluid p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Manage Products</h2>
            <div>
                <a href="insert-product.html" class="btn btn-primary me-2">
                    <i class="fas fa-plus"></i> Add New Product
                </a>
                <a href="index.html" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="productsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th class="text-center">Image</th>
                                <th>Product Name</th>
                                <th>Category</th>
                                <th>Brand</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <tr>
                                <td colspan="9" class="text-center">Loading products...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div class="modal fade" id="editProductModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <input type="hidden" id="edit_product_id">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Product Name *</label>
                                <input type="text" class="form-control" id="edit_product_name" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Price (₹) *</label>
                                <input type="number" step="0.01" class="form-control" id="edit_price" required>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Discount Price (₹)</label>
                                <input type="number" step="0.01" class="form-control" id="edit_discount_price">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Category *</label>
                                <select class="form-select" id="edit_category_id" required>
                                    <option value="">Select Category</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Brand</label>
                                <select class="form-select" id="edit_brand_id">
                                    <option value="">Select Brand</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Short Description *</label>
                                <input type="text" class="form-control" id="edit_short_description" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="edit_description" rows="3"></textarea>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Stock Quantity *</label>
                                <input type="number" class="form-control" id="edit_stock_quantity" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">SKU *</label>
                                <input type="text" class="form-control" id="edit_sku" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Image URL</label>
                                <input type="text" class="form-control" id="edit_image_url">
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_is_active">
                                    <label class="form-check-label" for="edit_is_active">Active</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="edit_is_featured">
                                    <label class="form-check-label" for="edit_is_featured">Featured</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateProduct()">Update Product</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let products = [];
        let categories = [];
        let brands = [];

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadCategories();
            loadBrands();
            loadProducts();
        });

        async function loadCategories() {
            try {
                const response = await fetch('../api/get_categories.php');
                if (response.ok) {
                    categories = await response.json();
                    populateCategorySelects();
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadBrands() {
            try {
                const response = await fetch('../api/get_brands.php');
                if (response.ok) {
                    brands = await response.json();
                    populateBrandSelects();
                }
            } catch (error) {
                console.error('Error loading brands:', error);
            }
        }

        function populateCategorySelects() {
            const selects = document.querySelectorAll('#edit_category_id');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Select Category</option>';
                categories.forEach(cat => {
                    select.innerHTML += `<option value="${cat.category_id}">${cat.category_name}</option>`;
                });
            });
        }

        function populateBrandSelects() {
            const selects = document.querySelectorAll('#edit_brand_id');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Select Brand</option>';
                brands.forEach(brand => {
                    select.innerHTML += `<option value="${brand.brand_id}">${brand.brand_name}</option>`;
                });
            });
        }

        async function loadProducts() {
            try {
                const response = await fetch('../api/product.php');
                if (response.ok) {
                    products = await response.json();
                    displayProducts();
                }
            } catch (error) {
                console.error('Error loading products:', error);
                document.getElementById('productsTableBody').innerHTML = 
                    '<tr><td colspan="9" class="text-center text-danger">Error loading products</td></tr>';
            }
        }

        // Resolve image path from admin/ directory
        function getImageSrc(u) {
            if (!u) return '';
            // If starts with ./images or images/, make it relative to site root from admin
            if (u.startsWith('./')) return '..' + u.slice(1);
            if (u.startsWith('images/')) return '../' + u;
            return u;
        }

        function displayProducts() {
            const tbody = document.getElementById('productsTableBody');
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">No products found</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>${product.product_id}</td>
                    <td class="text-center">
                        <img src="${getImageSrc(product.image_url) || ''}"
                             alt="${product.product_name}"
                             style="width: 50px; height: 50px; object-fit: contain; background:#fff; border:1px solid #e5e7eb; padding:2px; border-radius: 4px; display:block; margin:auto;"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/50x50?text=%20';">
                    </td>
                    <td>${product.product_name}</td>
                    <td>${product.category_name || 'N/A'}</td>
                    <td>${product.brand_name || 'N/A'}</td>
                    <td>
                        ${product.discount_price ? 
                            `<span class="text-decoration-line-through text-muted">₹${product.price}</span><br>
                             <span class="text-danger fw-bold">₹${product.discount_price}</span>` : 
                            `₹${product.price}`}
                    </td>
                    <td>
                        <span class="badge ${product.stock_quantity > 0 ? 'bg-success' : 'bg-danger'}">
                            ${product.stock_quantity}
                        </span>
                    </td>
                    <td>
                        <span class="badge ${product.is_active ? 'bg-success' : 'bg-secondary'}">
                            ${product.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning me-1" onclick="editProduct(${product.product_id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.product_id}, '${product.product_name}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function editProduct(productId) {
            const product = products.find(p => p.product_id == productId);
            if (!product) return;

            document.getElementById('edit_product_id').value = product.product_id;
            document.getElementById('edit_product_name').value = product.product_name;
            document.getElementById('edit_price').value = product.price;
            document.getElementById('edit_discount_price').value = product.discount_price || '';
            document.getElementById('edit_category_id').value = product.category_id;
            document.getElementById('edit_brand_id').value = product.brand_id || '';
            document.getElementById('edit_short_description').value = product.short_description || '';
            document.getElementById('edit_description').value = product.description || '';
            document.getElementById('edit_stock_quantity').value = product.stock_quantity;
            document.getElementById('edit_sku').value = product.sku;
            document.getElementById('edit_image_url').value = product.image_url || '';
            document.getElementById('edit_is_active').checked = product.is_active == 1 || product.is_active === true;
            document.getElementById('edit_is_featured').checked = product.is_featured == 1 || product.is_featured === true;

            const modal = new bootstrap.Modal(document.getElementById('editProductModal'));
            modal.show();
        }

        async function updateProduct() {
            const productId = document.getElementById('edit_product_id').value;
            const formData = new FormData();
            formData.append('product_name', document.getElementById('edit_product_name').value);
            formData.append('description', document.getElementById('edit_description').value);
            formData.append('short_description', document.getElementById('edit_short_description').value);
            formData.append('category_id', parseInt(document.getElementById('edit_category_id').value));
            formData.append('brand_id', document.getElementById('edit_brand_id').value ? parseInt(document.getElementById('edit_brand_id').value) : null);
            formData.append('sku', document.getElementById('edit_sku').value);
            formData.append('price', parseFloat(document.getElementById('edit_price').value));
            formData.append('discount_price', document.getElementById('edit_discount_price').value ? parseFloat(document.getElementById('edit_discount_price').value) : null);
            formData.append('stock_quantity', parseInt(document.getElementById('edit_stock_quantity').value));
            formData.append('image_url', document.getElementById('edit_image_url').value);
            formData.append('is_active', document.getElementById('edit_is_active').checked ? 1 : 0);
            formData.append('is_featured', document.getElementById('edit_is_featured').checked ? 1 : 0);
            
            try {
                const response = await fetch(`../api/update_products.php?id=${productId}`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('✓ Product updated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                    loadProducts();
                } else {
                    alert('✗ Error: ' + (result.message || 'Failed to update product'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('✗ Error updating product: ' + error.message);
            }
        }

        async function deleteProduct(productId, productName) {
            if (!confirm(`Are you sure you want to delete "${productName}"?`)) {
                return;
            }
            
            try {
                const response = await fetch('../api/delete_products.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: productId })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert('✓ Product deleted successfully!');
                    loadProducts();
                } else {
                    alert('✗ Error: ' + (result.message || 'Failed to delete product'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('✗ Error deleting product: ' + error.message);
            }
        }
    </script>
</body>
</html>

